# OnePaperSlide アプリケーション仕様書

> **Version**: 2.1  
> **最終更新**: 2026-01-13  
> **ステータス**: 実装完了（Phase 1-5 完了）

## 1. 概要

### 1.1 目的

公務員が上司への**業務改善提案**や**新規施策説明**に使用する、「**A3 横・1 枚**」の PowerPoint 資料を効率的に作成する Web アプリケーション。

### 1.2 対象ユーザー

- 公務員（地方自治体・中央省庁の職員）
- 上司への報告・提案資料を作成する担当者

### 1.3 成功指標

| 指標           | 目標値                                         |
| -------------- | ---------------------------------------------- |
| 生成品質       | ベタ書きメモから「9 割完成」レベルの資料を生成 |
| レイアウト精度 | 文字被り・図形ズレ発生率 0%                    |
| 操作性         | 入力 → ダウンロードまで 3 クリック以内         |

---

## 2. 機能要件

### 2.1 ユースケース

````mermaid
flowchart LR
A[ユーザー] -->|1. メモ入力| B[Streamlit UI]
B -->|2. AI 処理| C[Gemini API]
C -->|3. 構造化 JSON| D[レイアウトエンジン]
D -->|4. PPTX 生成| E[python-pptx]
E -->|5. ダウンロード| A

```text

#### 詳細フロー

1. **入力**: 提案内容のメモ（現状・課題・解決策などが混在したテキスト）をテキストエリアに貼り付け
2. **設定**: AI モデル選択（自動判別されたプロバイダーのモデルから選択）
3. **生成**: 「資料作成」ボタンをクリック
4. **AI 処理**:
   - 入力テキストの構造化（セクション分類）
   - 各セクションの要約・リライト
   - 最適なレイアウトテンプレートの選択
   - フローチャートのラベル・表の項目名を自動生成
5. **出力**: PPTX ファイルをダウンロード

### 2.2 画面・UI 仕様（Streamlit）

#### サイドバー

| 項目             | 説明                              |
| ---------------- | --------------------------------- |
| 項目             | 説明                              |
| ---------------- | --------------------------------- |
| API キー入力     | **マルチプロバイダー対応**（Gemini / OpenAI / Anthropic 自動判別） |
| AI モデル選択    | **動的リスト**（プロバイダーに応じたモデル一覧を表示）             |
| テンプレート種別 | 自動選択 / 手動選択（4 種類）                                            |
| デザイン設定     | アクセントカラー / 背景色変更     |

#### メインエリア

| 要素             | 仕様                                                           |
| ---------------- | -------------------------------------------------------------- |
| タイトル         | 「OnePaperSlide - A3 資料自動生成」                            |
| 原稿入力エリア   | 20 行以上の大型テキストエリア                                  |
| プレースホルダー | 「ここに提案内容のメモを貼り付けてください」                   |
| 文字数カウンター | 現在文字数 / 最大 10,000 文字                                  |
| 実行ボタン       | 「A3 資料を生成する」（青色・強調）                            |
| プレビュー       | 生成されたスライド構成（タイトル・見出し）をアコーディオン表示 |
| 結果表示         | ダウンロードボタン（.pptx）                                    |

### 2.3 レート制限機能

ユーザーごとの過剰な API リクエストを制御し、サービスの安定性を確保します。

| 項目     | 仕様                                                         |
| -------- | ------------------------------------------------------------ |
| 制限単位 | ブラウザセッションごと                                       |
| 制限値   | 1 分間に 5 リクエストまで                                    |
| 動作     | 制限超過時はエラーメッセージを表示し、API 呼び出しをブロック |

### 2.3 レイアウトテンプレート（4 種類）

#### テンプレート一覧

| ID  | 名称         | 用途           | 主要セクション                               |
| --- | ------------ | -------------- | -------------------------------------------- |
| T1  | 問題解決型   | 課題解決の提案 | 現状 → 課題 → 原因分析 → 解決策 → 期待効果   |
| T2  | 比較検討型   | 選択肢の比較   | 背景 → 選択肢 A/B/C 比較表 → 推奨案 → 根拠   |
| T3  | 施策提案型   | 新規施策の説明 | 背景 → 目的 → 施策概要 → スケジュール → 予算 |
| T4  | 業務フロー型 | プロセス改善   | 現状フロー → 課題 → 改善後フロー → 効果      |

#### グリッド構成（共通）

```text
┌─────────────────────────────────────────────────────────────┐
│ [ヘッダー] タイトル + サブタイトル + 日付・所属            │
├─────────────────────────────┬───────────────────────────────┤
│                             │                               │
│        左列（50%）          │         右列（50%）           │
│                             │                               │
│   - セクション1             │   - セクション3               │
│   - セクション2             │   - セクション4               │
│                             │   - セクション5               │
│                             │                               │
├─────────────────────────────┴───────────────────────────────┤
│ [フッター] 補足情報・連絡先・ページ番号                     │
└─────────────────────────────────────────────────────────────┘
```text

---

## 3. データ仕様（JSON Layout Engine）

### 3.1 設計思想

- **厳格な JSON 定義**: 全ての図形位置をピクセル単位で指定し、文字ズレ・図形被りを防止
- **外部定義ファイル**:
  - `templates/*.json`: レイアウトの大枠とセクション配置ルール定義
  - `components/*.json`: 各コンポーネント（箇条書き、表など）のデフォルトスタイル定義
- **ハイブリッド方式**: 4 つの基本テンプレート＋再利用可能な部品（コンポーネント）

### 3.2 JSON スキーマ構造

```json
{
  "template_id": "T1_problem_solving",
  "template_name": "問題解決型",
  "slide": {
    "width_mm": 420,
    "height_mm": 297,
    "background_color": "#FFFFFF"
  },
  "header": {
    "height_mm": 25,
    "elements": [
      {
        "type": "text",
        "id": "title",
        "x_mm": 15,
        "y_mm": 8,
        "width_mm": 300,
        "height_mm": 15,
        "font_size_pt": 28,
        "font_name": "メイリオ",
        "font_bold": true,
        "font_color": "#1A365D",
        "content_key": "title"
      }
    ]
  },
  "body": {
    "columns": 2,
    "column_gap_mm": 10,
    "sections": [
      {
        "id": "section_1",
        "column": 0,
        "type": "bullets",
        "header_text_key": "section_1_header",
        "content_key": "section_1_content",
        "style": {
          "header_font_size_pt": 18,
          "body_font_size_pt": 14,
          "accent_color": "#2B6CB0"
        }
      }
    ]
  },
  "footer": {
    "height_mm": 12,
    "elements": []
  },
  "components": {
    "available": ["table", "flowchart", "bullets", "kpi_box"]
  }
}
```text

### 3.3 コンポーネント種別

| 種別             | 識別子       | 用途         | 主要プロパティ            |
| ---------------- | ------------ | ------------ | ------------------------- |
| 表・マトリックス | `table`      | 比較・一覧   | rows, columns, header_row |
| フローチャート   | `flowchart`  | プロセス表現 | steps[], direction(h/v)   |
| 箇条書き         | `bullets`    | 要点リスト   | items[], indent_level     |
| KPI ボックス     | `kpi_box`    | 数値強調     | value, unit, label        |
| テキストブロック | `text_block` | 説明文       | content, alignment        |

### 3.4 文字溢れ対策（Auto-Shrink）

```python
# フォントサイズ自動縮小ロジック
MIN_FONT_SIZE = 8  # pt
SHRINK_STEP = 1    # pt

def auto_shrink_text(text, box_width, box_height, initial_font_size):
    """
    テキストがボックスに収まるまでフォントサイズを縮小
    """
    font_size = initial_font_size
    while font_size >= MIN_FONT_SIZE:
        if text_fits_in_box(text, box_width, box_height, font_size):
            return font_size
        font_size -= SHRINK_STEP
    return MIN_FONT_SIZE
```text

### 3.5 コンテンツ後処理（Content Post-Processing）

AI 生成テキストが長すぎてレイアウト崩れを起こすのを防ぐため、以下の自動整形を適用します。

| 対象           | 処理内容                                  |
| -------------- | ----------------------------------------- |
| 箇条書き       | 最大 7 項目、各項目 50 文字以内に切り詰め |
| フローチャート | 最大 6 ステップに制限                     |
| 長文テキスト   | 200 文字で省略（...付与）                 |

---

## 4. 技術仕様

### 4.1 アーキテクチャ

```mermaid
graph TB
    subgraph Frontend
        A[Streamlit UI]
    end
    subgraph Backend
        B[app.py - メインロジック]
        C[layout_engine.py - JSON→PPTX変換]
        D[ai_service.py - Gemini API連携]
    end
    subgraph Data
        E[templates/*.json - レイアウト定義]
        F[components/*.json - 部品定義]
    end
    subgraph External
        G[Google Generative AI API]
    end

    A --> B
    B --> C
    B --> D
    C --> E
    C --> F
    D --> G
```text

### 4.2 技術スタック

| レイヤー       | 技術                          | 理由                                    |
| -------------- | ----------------------------- | --------------------------------------- |
| フレームワーク | Streamlit (Python)            | 高速開発・Python エコシステム親和性     |
| スライド生成   | python-pptx                   | PowerPoint 操作のデファクトスタンダード |
| AI/LLM         | **マルチ対応** (Gemini, OpenAI, Anthropic) | ユーザーのAPIキーに応じて自動切り替え   |
| デプロイ       | Streamlit Community Cloud     | 無料・GitHub 連携・URL 共有可能         |

### 4.3 ディレクトリ構成

```text
OnepaperSlide/
├── app.py                    # メインアプリケーション
├── settings.yaml             # アプリケーション設定（定数管理）
├── requirements.txt          # 依存パッケージ
├── .streamlit/
│   └── secrets.toml          # APIキー（.gitignore対象）
├── src/
│   ├── __init__.py
│   ├── config.py             # 設定管理
│   ├── custom_types.py       # 型定義（TypedDict）
│   ├── logging_config.py     # ロギング設定
│   ├── layout_engine.py      # JSONレイアウトエンジン
│   ├── ai_service.py         # Gemini API連携
│   └── pptx_builder.py       # PPTX生成
├── templates/
│   ├── T1_problem_solving.json
│   ├── T2_comparison.json
│   ├── T3_policy_proposal.json
│   └── T4_workflow.json
├── components/
│   ├── table.json
│   ├── flowchart.json
│   └── bullets.json
├── tests/
│   └── test_layout_engine.py
└── docs/
    └── SPEC.md
```text

### 4.4 API 設計（Gemini 連携）

#### プロンプト構造

```python
SYSTEM_PROMPT = """
あなたは公務員向け資料作成の専門家です。
入力されたメモを以下の形式のJSONに構造化してください。

出力形式:
{
  "recommended_template": "T1" | "T2" | "T3" | "T4",
  "title": "資料タイトル",
  "subtitle": "サブタイトル",
  "sections": [
    {
      "id": "section_1",
      "header": "セクション見出し",
      "type": "bullets" | "table" | "flowchart" | "text",
      "content": {
        // 型に応じた構造化データ
      }
    }
  ],
  "footer_note": "補足情報"
}

注意事項:
- 各セクションの文章は端的でわかりやすい短文にすること
- 箇条書きは1項目あたり30文字以内
- フローチャートのステップは5個以内
- 表の列数は5列以内
"""
```text

---

## 5. デザイン仕様

### 5.1 カラーパレット

| 用途       | カラーコード | 説明                     |
| ---------- | ------------ | ------------------------ |
| プライマリ | `#2B6CB0`    | 青（見出し・アクセント） |
| セカンダリ | `#4A5568`    | グレー（本文）           |
| 背景       | `#FFFFFF`    | 白                       |
| 強調背景   | `#EBF8FF`    | 薄い青（ボックス背景）   |
| 境界線     | `#E2E8F0`    | 薄いグレー               |
| 警告・重要 | `#C53030`    | 赤（限定使用）           |

### 5.2 タイポグラフィ

| 要素             | フォント | サイズ | ウェイト |
| ---------------- | -------- | ------ | -------- |
| メインタイトル   | メイリオ | 28pt   | Bold     |
| セクション見出し | メイリオ | 18pt   | Bold     |
| 本文             | メイリオ | 14pt   | Regular  |
| 注釈・フッター   | メイリオ | 10pt   | Regular  |
| 表ヘッダー       | メイリオ | 12pt   | Bold     |
| 表本文           | メイリオ | 11pt   | Regular  |

### 5.3 余白・グリッド（A3 横: 420mm × 297mm）

| 要素           | サイズ |
| -------------- | ------ |
| 上余白         | 10mm   |
| 下余白         | 10mm   |
| 左右余白       | 15mm   |
| カラム間隔     | 10mm   |
| セクション間隔 | 8mm    |
| ヘッダー高さ   | 25mm   |
| フッター高さ   | 12mm   |
| 本文エリア高さ | 240mm  |

---

## 6. セキュリティ仕様

> [!CAUTION]
> GitHub パブリックリポジトリへの公開を前提とするため、以下のセキュリティ対策は**必須**です。

### 6.1 API キー管理

| 項目                 | 対策                                           |
| -------------------- | ---------------------------------------------- |
| コード内ハードコード | **厳禁**                                       |
| UI 入力（推奨）      | サイドバーの入力欄（セッション中はメモリ保持） |
| ローカル開発         | `.env` ファイル（.gitignore 対象）             |
| 本番環境             | Streamlit Secrets（`.streamlit/secrets.toml`） |
| 環境変数名           | `GEMINI_API_KEY`                               |

### 6.2 .gitignore の必須エントリ

```gitignore
# APIキー・シークレット
.env
.streamlit/secrets.toml

# Python
__pycache__/
*.pyc
.pytest_cache/

# IDE
.vscode/
.idea/

# 生成ファイル
*.pptx
output/
```text

### 6.3 入力バリデーション

- 入力テキストの最大長制限（10,000 文字）
- XSS/インジェクション対策（Streamlit の標準エスケープを利用）
- 不正な JSON 入力の検証

---

## 7. 非機能要件

### 7.1 パフォーマンス

| 指標       | 目標値                                |
| ---------- | ------------------------------------- |
| 生成時間   | 30 秒以内（入力 1,000 文字の場合）    |
| 同時接続数 | 10 ユーザー（Streamlit Cloud 無料枠） |

### 7.2 ユーザビリティ

- レスポンシブ対応（PC・タブレット）
- エラーメッセージは日本語で表示
- 処理中はプログレスインジケーター表示

### 7.3 保守性

- レイアウト定義は JSON ファイルに分離（コード変更不要で調整可能）
- コンポーネント単位でのモジュール化
- 型ヒント・docstring 必須

---

## 8. エッジケース・エラー処理

| シナリオ               | 対処                                 |
| ---------------------- | ------------------------------------ |
| API キー未設定         | 「API キーを設定してください」と明示 |
| API quota 超過         | エラーメッセージ＋リトライ案内       |
| 入力テキストが短すぎる | AI が補完するか、入力促進メッセージ  |
| 入力テキストが長すぎる | 10,000 文字で切り捨て＋警告          |
| AI 応答が不正な JSON   | リトライ（最大 3 回）後エラー表示    |
| PPTX 生成失敗          | エラーログ表示＋サポート案内         |

---

## 9. 実装フェーズ

### Phase 1: 基盤構築（Day 1-2）

- [ ] プロジェクトセットアップ（ディレクトリ構成・requirements.txt）
- [ ] Streamlit 基本 UI 構築（テキスト入力・ボタン・ダウンロード）
- [ ] .gitignore・セキュリティ設定

### Phase 2: JSON レイアウトエンジン（Day 3-4）

- [ ] JSON スキーマ定義
- [ ] 4 つの基本テンプレート JSON 作成
- [ ] layout_engine.py 実装（JSON→ 座標変換）
- [ ] pptx_builder.py 実装（座標 →PPTX）

### Phase 3: AI 連携（Day 5-6）

- [ ] Gemini API 連携（ai_service.py）
- [ ] 構造化プロンプト開発・チューニング
- [ ] テンプレート自動選択ロジック

### Phase 4: 統合・検証（Day 7-8）

- [ ] 全体結合
- [ ] テストケース作成・実行
- [ ] UI 調整・エラーハンドリング強化

### Phase 5: デプロイ（Day 9-10）

- [ ] GitHub リポジトリ作成（public）
- [ ] Streamlit Community Cloud デプロイ
- [ ] 動作確認・ドキュメント整備

---

## 10. 未決定事項・リスク

| 項目                 | 内容                       | 対処案                           |
| -------------------- | -------------------------- | -------------------------------- |
| Gemini API 制限      | 無料枠の上限（RPM/TPM）    | 使用量モニタリング＋アラート     |
| フォント埋め込み     | メイリオがない環境での表示 | システムフォントフォールバック   |
| 複雑なフローチャート | 自動配置の限界             | 手動調整を許容（9 割完成モデル） |

---

## 付録: 用語集

| 用語           | 定義                                                 |
| -------------- | ---------------------------------------------------- |
| 1 ペーパー     | A3 または A4 横 1 枚に情報をまとめた資料形式         |
| テンプレート   | 固定された大枠レイアウト（4 種類）                   |
| コンポーネント | 再利用可能な UI 部品（表・フロー等）                 |
| Auto-Shrink    | テキストがボックスを超える場合の自動フォント縮小機能 |
```text
````
